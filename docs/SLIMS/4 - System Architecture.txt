SYSTEM ARCHITECTURE

---

TECH STACK:

Frontend: Next.js 16, React 19, Tailwind CSS, Shadcn UI (Base UI), TanStack Query, TanStack Form, TanStack Table
Backend: Next.js 16 API Routes, Better Auth, Prisma, Node Mailer, Bull MQ, LogTape
Database: PostgreSQL 16, Redis 7.x
Storage: Local file system (EC2 volume for MVP); exports move to S3 later
Hosting: AWS EC2, Nginx, PM2, Let's Encrypt, Certbot

---

INTEGRATIONS:

- Better Auth: Multi-user-type authentication with magic link support
- Node Mailer: Transactional emails (magic links, notifications)
- Bull MQ: Background jobs (PDF generation, bulk uploads)
- Redis: Session caching + Bull MQ message broker

---

ARCHITECTURE PATTERN:

Monolithic Next.js Application (App Router)
- Single codebase, simplified deployment
- Bull MQ for background tasks
- Redis for session caching and job queues
- Suitable for MVP scale

---

COMPONENT BREAKDOWN:

- Next.js (Frontend): React UI, client-side routing, form handling, table rendering
- Next.js (Backend): API routes, server actions, authentication middleware
- PostgreSQL: Primary data store (users, sessions, logbook entries, comments)
- Redis: Session cache, Bull MQ message broker
- Bull MQ: Background job processing (PDF generation, bulk uploads, emails)
- Better Auth: Authentication service (credential + magic link)
- Prisma: Database ORM, query builder
- Node Mailer: Email service (SMTP)
- Nginx: Reverse proxy, SSL termination
- Let's Encrypt/Certbot: SSL certificate management
- LogTape: Application logging

---

DATA FLOW:

Authentication:
User → Nginx → Next.js (Frontend) → Next.js (Backend) → Better Auth → Redis (cache check) → PostgreSQL (session lookup) → Redis (cache write) → Next.js (Backend) → Next.js (Frontend) → User

Weekly Entry:
User → Nginx → Next.js (Frontend) → Next.js (Backend) → Prisma → PostgreSQL → LogTape → Next.js (Backend) → Next.js (Frontend) → User

Review Request:
User → Nginx → Next.js (Frontend) → Next.js (Backend) → Prisma → PostgreSQL → Bull MQ → Redis (job queue) → Bull MQ Worker → Node Mailer → SMTP → Supervisor Email

PDF Generation:
User → Nginx → Next.js (Frontend) → Next.js (Backend) → Bull MQ → Redis (job queue) → Bull MQ Worker → Prisma → PostgreSQL → PDF Generator → File System → Next.js (Backend) → Next.js (Frontend) → User

Magic Link Authentication:
Supervisor → Email Click → Nginx → Next.js (Backend) → Better Auth → PostgreSQL (verification table) → Redis (session create) → Next.js (Frontend) → Supervisor

Bulk Upload:
Admin → Nginx → Next.js (Frontend) → Next.js (Backend) → Bull MQ → Redis (job queue) → Bull MQ Worker → Prisma → PostgreSQL (batch insert) → LogTape → Bull MQ → Next.js (Backend) → Admin

Export Access:
User → Nginx → Next.js (Frontend) → Next.js (Backend) → Bull MQ → Redis (job queue) → Bull MQ Worker → Export File → Expiring URL → Nginx (prod) | Bun serve (dev) → File deleted on expiry

---

SECURITY:

Authentication:
- Better Auth (credential + magic link)
- Bcrypt password hashing
- HTTP-only cookies, 7-day sessions
- Redis session caching

Authorization:
- RBAC via user.user_type
- Row-level security in Prisma queries
- Middleware route protection

Data:
- PostgreSQL SSL in production
- Environment variables for secrets
- Prisma parameterized queries (SQL injection prevention)
- HTTPS via Let's Encrypt

Audit:
- activity_logs table tracks all user actions
- Week locking prevents tampering

---

BETTER AUTH INTEGRATION:

Setup:
1. Install: npm install better-auth @better-auth/cli
2. Generate schema: npx @better-auth/cli generate
3. Migrate: npx prisma migrate dev --name add_better_auth
4. Link existing users via better_auth_user_id

Configuration:
- Prisma adapter with PostgreSQL
- Magic link plugin for industry supervisors (5-min expiry)
- Redis secondary storage for sessions
- user.user_type discriminates admin/student/school_supervisor/industry_supervisor
- user.user_reference_id links to domain tables
- Experimental joins enabled (2-3x performance)

Authentication Flow:
- Credential: email/password → Better Auth → session (Redis + PostgreSQL)
- Magic Link: email → verification table → one-click access (no password)

---

DEPLOYMENT:

CI/CD: Manual deployment to EC2 for MVP
Environments: Production only (EC2)

---

MONITORING:

Logs: LogTape (structured logging)
Metrics: PM2 monitoring, Bull Board dashboard
Backups: Daily PostgreSQL backups, 30-day retention
